<dom-module id="stv-diseases-search">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            min-width: 700px;
            max-height: 500px;
            padding: 10px;
        }

        .but {
            color: #445D76;
            text-align: center;
            height: 20px;
            width: 115px;
            line-height: 20px;
            margin-top: 5px;
        }

        #allDiseases,
        #selectedDiseases {
            width: 95%;
            min-height: 345px;
            height: calc(100vh - 450px);
            border: 1px solid #d3d3d3;
        }

        .allDiseases {
            width: 50%;
            margin-right: 10px;
        }

        .selectedDiseases {
            width: 50%;
            margin-left: 10px;
        }

        .add-but {
            font-size: 13px;
            font-weight: bold;
            color: #2F65F4;
            text-align: center;
            height: 30px;
            width: 150px;
            line-height: 30px;
            margin-top: 10px;
        }
    </style>
    <template>
        <div class="disease horizontal layout">
            <div class="allDiseases">
                <stv-table id="allDiseases" class="flex" columns="{{allDiseaseColumns}}" data="{{allDiseasesData}}" enable-select enable-filter enable-paging hide-column-selector page-size="15"></stv-table>
                <div class="stv-btn stv-btn-shdw but" on-click="handleAddSelectedDiseases"><i class="fa fa-plus-square-o"></i>&nbsp; Add
                </div>
            </div>
            <div class="selectedDiseases">
                <stv-table id="selectedDiseases" class="flex" columns="{{diseaseColumns}}" data="{{selectedDisease}}" enable-paging hide-column-selector>
                </stv-table>
                <div class="stv-btn stv-btn-shdw but" on-click="handleClearSelectedDiseases">
                    Clear
                </div>
            </div>
        </div>
        <div class="horizontal layout flex" style="width: 100%">
            <div class="flex">
            </div>
            <div class="stv-btn stv-btn-shdw add-but" on-click="handleAddSelected"> Add Selected
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: "stv-diseases-search",
            properties: {
                selectedDisease: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },
                mapSelectedDisease: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },
                diseaseValue: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                },
            },
            ready: function() {
                var me = this;

                if (localStorage.bioinfo_team_diseases) {
                    this.allDiseasesData = JSON.parse(localStorage.bioinfo_team_diseases);

                } else {
                    $.ajax({
                        url: "http://bioinfodev.hpc.cam.ac.uk/cellbase-legacy/webservices/rest/v3/hsapiens/feature/clinical/phenotype-gene?include=clinvar,gwas",
                        //only in cellbase v3
                        dataType: 'json',
                        async: false,
                        success: function(response, textStatus, jqXHR) {
                            try {
                                var data = response.response;
                                var clinvar = data[0].result;
                                var gwas = data[1].result;

                                var diseases = [];

                                for (var i = 0; i < clinvar.length; i++) {
                                    var dis = clinvar[i];
                                    dis.source = "clinvar";
                                    diseases.push(dis);
                                }
                                for (var i = 0; i < gwas.length; i++) {
                                    var dis = gwas[i];
                                    dis.source = "gwas";
                                    diseases.push(dis);
                                }

                                diseases.sort(function(a, b) {
                                    return a.phenotype.localeCompare(b.phenotype);
                                });

                                if (diseases.length > 0) {
                                    me.allDiseasesData = diseases;
                                    localStorage.bioinfo_team_diseases = JSON.stringify(diseases);
                                }

                            } catch (e) {

                            }

                        }
                    });

                }

                this.allDiseaseColumns = [{
                    name: 'phenotype',
                    title: 'Phenotype',
                    type: 'text',
                    width: 325
                }, {
                    name: 'source',
                    title: 'Source',
                    type: 'select',
                    options: ["clinvar", "gwas"],
                    width: 125
                }];
                this.diseaseColumns = [{
                    name: 'phenotype',
                    title: 'Phenotype',
                    type: 'text',
                    width: 310
                }, {
                    name: 'source',
                    title: 'Source',
                    type: 'select',
                    options: ["clinvar", "gwas"],
                    width: 110
                }, {
                    name: '',
                    title: '',
                    type: 'action',
                    width: 30
                }];
            },
            handleAddSelectedDiseases: function() {
                for (var i = 0; i < this.$.allDiseases.selected.length; i++) {
                    var disease = this.$.allDiseases.selected[i];
                    if (this.mapSelectedDisease[disease.phenotype] == null) {
                        this.mapSelectedDisease[disease.phenotype] = true;
                        this.push('selectedDisease', disease);
                    }
                }
            },
            handleClearSelectedDiseaSE: function(e) {
                this.selectedDisease = [];
                this.mapSelectedDisease = {};
            },
            handleAddSelected: function(e) {
                this.set('diseaseValue', this.selectedDisease);
                this.fire('added');
            },
        })
    </script>
</dom-module>
