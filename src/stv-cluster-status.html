<link rel="import" href="../../polymer/polymer.html">
<link rel="stylesheet" href="../../fontawesome/css/font-awesome.css">
<link rel="import" href="./stv-tooltip.html">
<dom-module id="stv-cluster-status">
    <template>
    <style>
        :host {
            position: relative;
            display: block;
            box-sizing: border-box;
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.4);
        }

        .status_danger {
            --button-style-color: #e60000;
            color: #e60000;
        }

        .status_warning {
            --button-style-color: #ffcc00;
            color: #ffcc00;
        }

        .status_ok{
            --button-style-color: #00ff00;
            color: #00ff00;
        }

        .status_default {
            --button-style-color: #a8a8a8;
            color: #a8a8a8;
        }

        ul {
            list-style: none;
            color: black;
            text-align: left;
            min-width: 300px;
            margin: 0;
            padding: 0.5em 1em;
        }

        h1 {
            font-size: 1.2em;
            font-weight: bold;
            color: black;
        }

        .cluster_data {
            margin-left: 10px;
            float: right;
        }

    </style>
        <stv-tooltip icon="database" class$="{{_computeStatusClass(_serverStatusObject)}}">
            <h1>Cluster Status</h1>
            <ul>
                <li><i class$="{{_computeSingleElementStatusClass(_serverStatusObject.cpuUsage, _statusThresholds.cpu_Mem)}} fa"></i>
                    CPU: <span class="cluster_data">{{_roundNumber(_serverStatusObject.cpuUsage, 2)}}</span></li>
                <li><i class$="{{_computeSingleElementStatusClass(_serverStatusObject.memUsage, _statusThresholds.cpu_Mem)}} fa"></i> Memory Usage: <span class="cluster_data">{{_roundNumber(_serverStatusObject.memUsage, 2)}}</span></li>
                <li><i class$="{{_computeSingleElementStatusClass(_serverStatusObject.latency, _statusThresholds.latency)}} fa"></i>Cluster Latency: <span class="cluster_data">{{_serverStatusObject.latency}} ms</span></li>
                <li><i class="fa fa-globe"></i> Connexion Latency: <span class="cluster_data">{{_connexionLatency}} ms</span></li>
                <hr>
                <li>Jobs Running: <span class="cluster_data">{{_serverStatusObject.jobsRunning}}</span></li>
                <li>Jobs Awaiting: <span class="cluster_data">{{_serverStatusObject.jobsWaiting}}</span></li>
            </ul>
        </stv-tooltip>
    </template>

    <script>
        Polymer({
            is: "stv-cluster-status",
            properties: {
                clusterApi: String,
                _serverStatusObject: {
                    type: JSON
                },

                _statusThresholds: {
                    value: function() {
                        return {
                            cpu_Mem: {danger: 0.9, warning: 0.5},
                            latency: {danger: 1000, warning: 500}
                        }
                    }
                },

                _connexionLatency: Number,
            },
            ready: function() {

            },

            attached: function() {
                this.retrieveServerStatus(this.clusterApi);

                this._timer = setInterval(function(){
                    this.retrieveServerStatus(this.clusterApi);
                }.bind(this), 5000);
            },

            retrieveServerStatus: function(url){
                var startRequestTime = new Date();
                url = url + "?rand=" + startRequestTime.getTime();
                var oReq = new XMLHttpRequest();
                var that = this;

                function reqListener() {
                    var jsonObject = JSON.parse(this.responseText);
                    that._serverStatusObject = jsonObject;
                    that._connexionLatency = new Date() - startRequestTime;
                    console.log(that._serverStatusObject);
                }

                oReq.open("GET", url);
                oReq.send();

                oReq.addEventListener("load", reqListener);
                oReq.addEventListener("error", function() {
                    console.error("Server currently unavailable at " + url);
                    that._serverStatusObject = null;
                }.bind(this));
            },

            _computeStatusClass(serverStats){
                if(serverStats){
                    var newClass = "";
                    if(this._checkStatusThreshold(serverStats, this._statusThresholds.cpu_Mem.danger)){
                        newClass = "status_danger";
                    } else if(this._checkStatusThreshold(serverStats, this._statusThresholds.cpu_Mem.warning)){
                        newClass = "status_warning";
                    }else {
                        newClass = "status_ok";
                    }
                }else {
                    newClass = "status_default";
                }

                this.async(function(){
                        this.updateStyles(); // Necessary for the custom css variable to apply when update
                }.bind(this), 10);

                return newClass;

            },

            _checkStatusThreshold(serverStats ,threshold){
                return serverStats.cpuUsage >= threshold || serverStats.memUsage >= threshold;
            },

            _roundNumber: function(number ,digits){
                return number.toFixed(digits);
            },

            _computeSingleElementStatusClass(value, thresholds){
                if(value >= thresholds.danger){
                    return "status_danger fa-warning";
                }else if(value >= thresholds.warning){
                    return "status_warning fa-warning";
                }else if(value < thresholds.warning){
                    return "status_ok fa-check";
                }
                return "status_default fa-circle";
            }
        })
    </script>
</dom-module>
