<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../iron-flex-layout/iron-flex-layout-classes.html">
<dom-module id="stv-file-origin">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            position: relative;
        }

        .labelSelection {
            margin-left: 10px;
        }

        #fileBrowserPanel {
            width: 700px;
            height: 500px;
            min-width: 700px;
            min-height: 500px;
            font-size: 13px;
        }
    </style>
    <template>

        <template is="dom-if" if="{{check(selectionMode,'file')}}">
            <template is="dom-if" if="{{allowTextArea}}">
                <form class="horizontal layout" style="margin-bottom:5px;">
                    <label class="stv-control">
                        <input type="radio" name="origin" value="server" on-change="handleOriginChange" checked>
                        <span>File</span>
                    </label>

                    <label class="stv-control">
                        <input type="radio" name="origin" value="textarea" on-change="handleOriginChange">
                        <span>Text area</span>
                    </label>
                </form>
            </template>
        </template>


        <div hidden$="{{!check(dataOrigin,'server')}}">
            <template is="dom-if" if="{{check(selectionMode,'file')}}">
                <div style="color:#666;margin-bottom: 5px;">
                    The files must be on the server to select them.
                    <br> You can upload files using the button
                    <i class="fa fa-cloud-upload" style="font-size: 16px;"></i> inside file browser.
                </div>
            </template>
            <template is="dom-if" if="{{check(selectionMode,'folder')}}">
                <div style="color:#666;margin-bottom: 5px;">
                    You can create folders using the button
                    <i class="fa fa-folder" style="font-size: 16px;"></i> + inside file browser.
                </div>
            </template>
            <div class="horizontal layout">
                <div class="stv-btn stv-btn-shdw" style="width:150px;" on-click="buttonHandler">File browser</div>
                <div id="selection" style="line-height: 25px;" class="labelSelection">
                    <span>{{selectedFile.path}}</span>
                </div>
            </div>
            <div hidden$="{{showBrowser}}">
                <br>
                <stv-panel hidden fixed modal closable id="fileBrowserPanel">
                    <div class="header">
                        Browse file...
                    </div>
                    <stv-file-browser enable-select-ok id="fileBrowser" class="container flex" mode="{{selectionMode}}" on-fileselect="handleFileSelect" bioformats="{{bioformats}}" user-data="{{userData}}" on-ok-click="handleClickOk">
                    </stv-file-browser>
                </stv-panel>
            </div>
        </div>

        <template is="dom-if" if="{{check(dataOrigin,'textarea')}}">
            <template is="dom-if" if="{{allowTextArea}}">
                <label class="stv">You can paste your ids here:</label>

                <div class="horizontal layout">
                    <textarea class="stv" rows="10" cols="20" value="{{textAreaValue}}">
                    </textarea>
                </div>
            </template>
        </template>

    </template>
    <script>
        Polymer({
            is: "stv-file-origin",
            properties: {
                userData: {
                    type: Object
                },
                allowTextArea: {
                    type: Boolean,
                    reflectToAttribute: true,
                    value: false
                },
                showBrowser: {
                    type: Boolean,
                    reflectToAttribute: true,
                    value: false
                },
                dataOrigin: {
                    type: String,
                    value: 'server'
                },
                textAreaValue: {
                    type: String,
                    value: ''
                },
                selectionMode: {
                    type: String,
                    value: ''
                },
                selectedFile: {
                    type: Object,
                },

                bioformats: {
                    type: Array
                }
            },
            check: function(s, v) {
                return s === v;
            },
            buttonHandler: function() {
                this.$.fileBrowserPanel.hidden = false;
            },
            handleFileSelect: function(e) {
                var file = e.detail;
                var foundBioformat = false;
                for (var i = 0; i < this.bioformats.length; i++) {
                    var bf = this.bioformats[i];
                    if (bf.value == file.bioformat) {
                        foundBioformat = true;
                        break;
                    }
                }
                if (foundBioformat) {
                    this.set('file', file);
                    this.fire('validfileselect', file);
                }
            },
            handleClickOk: function(e) {
                var selectedFile = e.currentTarget.selectedFile;
                this.set('selectedFile', selectedFile);
            },
            selectHandler: function(e) {
                this.showBrowser = false;
                this.selectedFile = e.detail.file;
            },
            handleCancel: function(e) {
                this.selectedFile = undefined;
                this.showBrowser = false;
            },
            handleOriginChange: function(e) {
                this.dataOrigin = e.target.value;
                this.textAreaValue = "";
            },
            reset: function() {
                this.set('selectedFile', null);
            },
            computeSelectedName: function(object) {
                if (object != null) {
                    return object.name + '/'
                } else {
                    return '';
                }
            }
        });
    </script>
</dom-module>
