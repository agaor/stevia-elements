<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../iron-flex-layout/iron-flex-layout-classes.html">
<dom-module id="stv-job-item">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        :host(:hover) {
            background-color: var(--hover-color);
        }

        :host[selected] {
            background-color: var(--selected-color);
        }

        .capitalize {
            text-transform: capitalize;
        }

        .ERROR,
        .EXEC_ERROR,
        .QUEUE_ERROR,
        .QUEUE_WAITING_ERROR {
            color: #b30000;
        }

        .QUEUED {
            color: #ff8c00;
        }

        .RUNNING {
            color: #298c63;
        }

        .DONE {
            color: #0068cc;
        }

        .date {
            color: var(--secondary-text-color);
            font-size: 0.9em;
        }

        .bar > * {
            margin: 1px;
            color: #666;
        }

        .bar > *:hover {
            color: #000;
            cursor: pointer;
        }

        .log-file {
            color: #ad2a2a !important;
        }

        .log-file:hover {
            color: #b30000 !important;
        }

        .delete-job:hover {
            color: #b30000 !important;
        }

        .relaunch-job:hover {
            color: #298c63 !important;
        }

        .info-job:hover {
            color: #0068cc !important;
        }

        .download {
            color: #000 !important;
        }

        .data {
            color: var(--secondary-text-color);
        }

        #filePreviewPanel .container {
            width: 800px;
            height: 600px;
            padding: 10px;
            overflow-y: auto;
            overflow-x: auto;
        }
    </style>
    <template>
        <div id="content">
            <div id="job">
                <div>
                    <i class$="{{computeStatusIcon(job)}}"></i>
                    <span style="white-space: nowrap">{{job.name}}</span>
                </div>
                <div class="horizontal layout center">
                    <div style="padding-right:5px;" class="capitalize">{{computeToolName(job)}}</div>
                    <div style="padding-right:5px;" class$="{{computeStatusClass(job)}}">{{computeStatus(job)}}</div>
                    <div style="padding-right:5px;" class="date flex">{{computeDate(job)}}</div>
                    <div class="bar" id="bar">
                        <template is="dom-if" if="{{!isRunning(job)}}">
                            <template is="dom-if" if="{{showLogFile(job)}}">
                                <i class="fa fa-file-o log-file" title="View log file" on-click="handleViewLogFile"></i>
                                <span style="margin-right:5px;"></span>
                            </template>
                            <i class="fa fa-trash-o delete-job" title="Delete Job" on-click="handleDeleteJob"></i>
                            <i class="fa fa-refresh relaunch-job" title="Relaunch Job" on-click="handleRelaunchJob" hidden$="{{hideRelaunch(job)}}"></i>
                            <!-- <i class="fa fa-info info-job" title="Job information" on-click="handleJobInformation"></i> -->
                            <!-- <i class="fa fa-download" title="Download" hidden="{{!showInfo}}"></i> -->
                            <i class="fa fa-bug" title="Report Error" hidden="{{!hasError(job)}}" on-click="handleReportError"></i>
                        </template>
                    </div>
                </div>
            </div>
            <!-- <div id="fileInfo" class="vertical layout flex" hidden="{{!showInfo}}">
                <div class="horizontal layout">
                    <span class="data">Description:&nbsp;</span>
                    <span class="value">{{job.description}}</span>
                </div>
            </div> -->
            <stv-panel modal fixed closable hidden id="filePreviewPanel">
                <div class="header">
                    <i class="fa fa-eye"></i> File Preview
                </div>
                <stv-file-preview class="container" id="filePreview"></stv-file-preview>
            </stv-panel>
        </div>
    </template>
    <script>
        Polymer({
            is: "stv-job-item",
            properties: {
                job: {
                    type: Object,
                    notify: true,
                },
                showInfo: {
                    type: Boolean,
                    value: false
                },
                contentData: {
                    type: String,
                    value: "",
                },
                disableRelaunch: {
                    type: Boolean,
                    reflectToAttribute: true,
                    value: false
                }
            },
            created: function() {},
            computeDate: function(job) {
                var date = new Date(Date.parse(job.createdAt));
                return date.toLocaleString();
            },
            computeStatusIcon: function(job) {
                var iconMap = {
                    "EXEC_ERROR": 'ERROR fa fa-times',
                    "QUEUE_ERROR": 'ERROR fa fa-times',
                    "QUEUE_WAITING_ERROR": 'ERROR fa fa-times',
                    "ERROR": 'ERROR fa fa-times',
                    "QUEUED": 'QUEUED fa fa-clock-o',
                    "RUNNING": 'RUNNING fa fa-circle-o-notch fa-spin',
                    "DONE": 'DONE fa fa-check'
                };
                return iconMap[job.status];
            },
            computeStatus: function(job) {
                return job.status.toLowerCase();
            },
            computeStatusClass: function(job) {
                return "capitalize " + job.status;
            },
            computeToolName: function(job) {
                if (job.execution != null && job.execution != '') {
                    return job.execution;
                }
                return job.tool;
            },
            hideRelaunch: function(job) {
                if ((job.status === "DONE" || job.status.indexOf("ERROR") != -1) && this.disableRelaunch == false) {
                    return false;
                }
                return true;
            },
            isRunning: function(job) {
                return job.status == "RUNNING";
            },
            showLogFile: function(job) {
                if (window.STEVIA_SHOW_JOB_ERROR_FILES !== true) {
                    return false;
                } else {
                    return true;
                }
            },
            hasError: function(job) {
                return job.status.indexOf("ERROR") != -1;
            },
            handleDeleteJob: function(e) {
                var me = this;
                e.stopPropagation();
                if (confirm("Are you sure?")) {
                    SteviaManager.jobs.delete({
                        query: {
                            jobId: this.job._id,
                        },
                        request: {
                            success: function(response) {
                                if (response.response[0].error == null) {
                                    console.log('Job deleted');
                                } else {
                                    console.log(response.response[0].error);
                                }
                                me.fire('need-refresh');
                            },
                            error: function() {
                                console.log('Server error, try again later.');
                            }
                        }
                    });
                }
            },
            handleRelaunchJob: function(e) {
                e.stopPropagation();
                var me = this;
                if (confirm("You are going to relaunch this Job. Are you sure?")) {
                    var query = {
                        name: this.job.name,
                        description: this.job.description,
                        outdirId: this.job.folder.parent
                    };
                    var jobConfig = {};
                    jobConfig.options = this.job.options;
                    jobConfig.tool = this.job.tool;
                    jobConfig.execution = this.job.execution;
                    jobConfig.executable = this.job.executable;

                    SteviaManager.jobs.create({
                        query: query,
                        request: {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(jobConfig),
                            success: function(response) {
                                if (response.response[0].error == null) {
                                    console.log(response);
                                } else {
                                    console.log(response.response[0].error);
                                }
                                me.fire('need-refresh');
                                me.fire('job-launched');
                            },
                            error: function() {
                                console.log('Server error, try again later.');
                            }
                        }
                    });
                }
            },

            // handleJobInformation: function(e) {
            //     e.stopPropagation();
            //     this.showInfo = !this.showInfo;
            // },

            handleViewLogFile: function(e) {
                e.stopPropagation();
                this.$.filePreview.fileId = this.job.olog;
                this.$.filePreviewPanel.show();
            },
            handleReportError: function(e) {
                e.stopPropagation();
                var jobId = this.job._id;
                SteviaManager.jobs.reportError({
                    id: jobId,
                    request: {
                        success: function(response) {
                            if (response.response[0].error == null) {
                                alert(response.response[0].results[0]);
                            } else {
                                alert('Sorry! There was a problem, try again later');
                            }
                        },
                        error: function() {
                            console.log('Server error, try again later');
                        }
                    }
                });
            }
        });
    </script>
</dom-module>
